name: 'Arturo Builder'
description: 'Setup Arturo environment'
branding:
    icon: terminal
    color: purple
inputs:
    mode:
        description: >-
            The Arturo version to install
            (one of: 'mini', 'full', 'docgen', 'safe')
        default: 'full'
    token:
        description: >-
            The GITHUB_TOKEN secret.
        required: true
    arch:
        description: >-
            The architecture to build for.
            (one of: 'amd64', 'arm64')
        default: 'amd64'
    src:
        description: >-
            Which Arturo version to use.
        default: ''
    metadata:
        description: >-
            Embeddable build metadata
        default: ''
    os:
        description: >-
            Target operating system
            (one of: 'linux', 'windows', 'macos', 'freebsd', 'web')
        default: 'linux'
    support:
        description: >-
            Build support level (empty for standard, 'legacy' for older systems)
        default: ''
    create_artifact:
        description: >-
            Whether to create and upload artifact
        default: 'false'
    artifact_version:
        description: >-
            Version string for artifact naming (e.g., 0.9.84 or master.abc1234)
        default: ''
 
runs:
    using: "composite"
    steps:

        ##====================================
        ## General setup
        ##====================================

        - name: Sanitize inputs & auto-detect platform
          run: |
            if [ "${{ inputs.os }}" = "" ] || [ "${{ inputs.os }}" = "linux" ]; then
                case "${{ runner.os }}" in
                    Linux)   detected_os="linux" ;;
                    macOS)   detected_os="macos" ;;
                    Windows) detected_os="windows" ;;
                    *)       detected_os="linux" ;;
                esac
            else
                detected_os="${{ inputs.os }}"
            fi

            if [ "${{ inputs.arch }}" = "" ] || [ "${{ inputs.arch }}" = "amd64" ]; then
                case "${{ runner.arch }}" in
                    ARM64) detected_arch="arm64" ;;
                    X64)   detected_arch="amd64" ;;
                    *)     detected_arch="amd64" ;;
                esac
            else
                detected_arch="${{ inputs.arch }}"
            fi

            # Determine WebKit version based on support level
            if [ "${{ inputs.support }}" = "legacy" ]; then
                detected_webkit="40"
            else
                if [ "${{ runner.os }}" = "Linux" ]; then
                    UBUNTU_VERSION=$(lsb_release -rs 2>/dev/null || echo "24.04")
                    if [[ "$UBUNTU_VERSION" < "24.04" ]]; then
                        detected_webkit="40"
                    else
                        detected_webkit="41"
                    fi
                else
                    detected_webkit="41"
                fi
            fi

            if [ "$detected_os" = "web" ]; then
                detected_mode="web"
            else
                detected_mode="${{ inputs.mode != '' && inputs.mode || 'full' }}"
            fi

            echo "os=$detected_os" >> $GITHUB_ENV
            echo "arch=$detected_arch" >> $GITHUB_ENV
            echo "mode=$detected_mode" >> $GITHUB_ENV
            echo "webkit=$detected_webkit" >> $GITHUB_ENV
            echo "support=${{ inputs.support }}" >> $GITHUB_ENV
            echo "src=${{ inputs.src }}" >> $GITHUB_ENV
            echo "metadata=${{ inputs.metadata }}" >> $GITHUB_ENV
          shell: bash

        - name: Debug build configuration
          run: |
            echo "======================================"
            echo "Arturo Builder Configuration"
            echo "======================================"
            echo "Runner OS:        ${{ runner.os }}"
            echo "Runner Arch:      ${{ runner.arch }}"
            echo "======================================"
            echo "Target OS:        ${{ env.os }}"
            echo "Target Arch:      ${{ env.arch }}"
            echo "Build Mode:       ${{ env.mode }}"
            echo "Support Level:    ${{ env.support != '' && env.support || '(standard)' }}"
            echo "WebKit Version:   ${{ env.webkit }}"
            echo "Source Ref:       ${{ env.src != '' && env.src || '(latest)' }}"
            echo "Metadata:         ${{ env.metadata != '' && env.metadata || '(none)' }}"
            echo "======================================"
          shell: bash

        - name: Checkout Arturo repo
          if: env.os != 'freebsd'
          uses: actions/checkout@v4
          with:
            repository: arturo-lang/arturo
            submodules: recursive
            path: arturo-src
            ref: ${{ env.src }}

        - name: Set build metadata
          if: env.os != 'freebsd' && env.metadata != ''
          run: |
            echo "${{ env.metadata }}" > arturo-src/version/metadata
          shell: bash

        - name: Export runtime flags
          run: |
            # Determine if tests can be executed
            if [ "${{ env.os }}" = "web" ] || \
               [ "${{ env.mode }}" = "safe" ]; then
                echo "arturoCanRun=false" >> $GITHUB_ENV
            else
                echo "arturoCanRun=true" >> $GITHUB_ENV
            fi
          shell: bash

        ##====================================
        ## OS-specific preparations
        ##====================================

        - name: Cache ChooseNim
          if: runner.os == 'Linux' || runner.os == 'macOS'
          id: cache-choosenim
          uses: actions/cache@v4
          with:
            path: ~/.choosenim
            key: ${{ runner.os }}-choosenim-${{ steps.get-date.outputs.date }}
  
        - name: Cache Nimble
          if: runner.os == 'Linux' || runner.os == 'macOS'
          id: cache-nimble
          uses: actions/cache@v4
          with:
            path: ~/.nimble
            key: ${{ runner.os }}-nimble-v2-${{ hashFiles('*.nimble') }}

        - name: Setup Msys
          if: runner.os == 'Windows'
          uses: msys2/setup-msys2@v2
          with:
            update: true
            cache: true
            install: 'git base-devel p7zip mingw-w64-x86_64-toolchain'

        ##====================================
        ## Setup Nim & dependencies
        ##====================================

        - name: Install Nim & dependencies (Linux)
          if: runner.os == 'Linux' && env.os != 'freebsd'
          run: |
            sudo apt-get update
            sudo apt-get install libpcre3

            if [ "${{ env.mode }}" != "mini" ]; then
                sudo apt-get install libgtk-3-dev libmpfr-dev
                UBUNTU_VERSION=$(lsb_release -rs)
                if [[ "$UBUNTU_VERSION" < "24.04" ]] || [ "${{ env.support }}" = "legacy" ]; then
                    sudo apt-get install -y libwebkit2gtk-4.0-dev
                else
                    sudo apt-get install -y libwebkit2gtk-4.1-dev
                fi
            fi

            if [ "${{ env.mode }}" == "web" ]; then
                 npm install -g uglify-js
            fi

            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo >> /home/runner/.bashrc
            echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> /home/runner/.bashrc
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

            brew install nim

            echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          shell: bash

        - name: Install Nim & dependencies (macOS)
          if: runner.os == 'macOS'
          run: |
            brew update
            brew install pcre nim
          shell: bash

        - name: Install Nim & dependencies (Windows)
          if: runner.os == 'Windows'
          run: |
            if [ "${{ env.mode }}" = "full" ]; then
                pacman --noconfirm -S mingw-w64-x86_64-mpfr
            fi

            mkdir nim
            curl -L https://nim-lang.org/download/nim-2.2.6_x64.zip -o nim.zip
            7z x nim.zip -onim
            rm nim.zip
          shell: msys2 {0}

        ##====================================
        ## Compilation
        ##====================================
        
        - name: Build Arturo (*)
          if: env.os != 'freebsd' && runner.os != 'Windows'
          run: |
            cd arturo-src
            ./build.nims --install --mode ${{ env.mode }} --arch ${{ env.arch }} --log
            echo "$HOME/.arturo/bin" >> $GITHUB_PATH
            cd ..
            
            rm -rf arturo-src
            echo "arturoDistPath=$HOME/.arturo/bin" >> $GITHUB_ENV
          shell: bash

        - name: Build Arturo (FreeBSD)
          if: env.os == 'freebsd'
          uses: vmactions/freebsd-vm@v1
          with:
            usesh: true
            sync: rsync
            copyback: true
            prepare: |
              pkg update
              pkg install -y wget nim bash git
              if [ "${{ env.mode }}" = "full" ]; then
                  pkg install -y pkgconf gtk3 mpfr ca_root_nss openssl webkit2-gtk_41
              fi
            run: |
              git clone --recursive https://github.com/arturo-lang/arturo.git arturo-src
              cd arturo-src
              git config --global --add safe.directory '*'
              if [ -n "${{ env.src }}" ]; then
                  git fetch origin ${{ env.src }}
                  git checkout FETCH_HEAD
              fi
              ${{ env.metadata != '' && format('echo "{0}" > version/metadata', env.metadata) || '' }}
              export PATH="/usr/local/nim/bin/:$PATH"
              ./build.nims --install --mode ${{ env.mode }} --log
              cd ..

              cp -r $HOME/.arturo/bin/* /usr/local/bin/
              
              rm -rf arturo-src
              
              mkdir -p arturo-bin
              cp -r /usr/local/bin/arturo* arturo-bin/
              echo "arturoDistPath=arturo-bin" >> $GITHUB_ENV

        - name: Build Arturo (Windows)
          if: runner.os == 'Windows'
          run: |
            export PATH="${{ github.workspace }}/nim/nim-2.2.6/bin":$PATH

            cd arturo-src
            ./build.nims --install --mode ${{ env.mode }} --log
            cd ..
            
            mkdir bin
            if [ "${{ env.mode }}" = "full" ]; then
                cp arturo-src/src/extras/webview/deps/dlls/x64/webview.dll bin
                cp arturo-src/src/extras/webview/deps/dlls/x64/WebView2Loader.dll bin
                curl -L https://arturo-lang.s3.amazonaws.com/libgmp-10.dll -o bin/libgmp-10.dll
                curl -L https://arturo-lang.s3.amazonaws.com/libmpfr-6.dll -o bin/libmpfr-6.dll
                curl -L https://arturo-lang.s3.amazonaws.com/sqlite3_64.dll -o bin/sqlite3_64.dll
                curl -L https://arturo-lang.s3.amazonaws.com/libgcc_s_seh-1.dll -o bin/libgcc_s_seh-1.dll
            fi

            curl -L https://curl.se/ca/cacert.pem -o bin/cacert.pem
            cp /mingw64/bin/libwinpthread-1.dll bin

            cp arturo-src/bin/arturo.exe bin

            cp bin/* /usr/bin
            
            rm -rf arturo-src
            echo "arturoDistPath=${{ github.workspace }}/bin" >> $GITHUB_ENV
          shell: msys2 {0}

        ##====================================
        ## Artifact creation
        ##====================================

        - name: Create artifact
          if: inputs.create_artifact == 'true'
          shell: bash
          id: artifact-prep
          run: |
            platform="${{ env.os }}"
            
            arch_or_format="${{ env.arch }}"
            if [ "${{ env.os }}" = "web" ]; then
                arch_or_format="js"
            fi

            processed_mode="${{ env.mode }}"
            if [ "${{ env.mode }}" = "web" ]; then
                processed_mode="mini"
            fi
            
            artifact_name="arturo-${{ inputs.artifact_version }}-${platform}-${arch_or_format}"
            if [ "$processed_mode" != "full" ]; then
                artifact_name="${artifact_name}-${processed_mode}"
            fi
            
            if [ "${{ env.support }}" = "legacy" ]; then
                artifact_name="${artifact_name}-legacy"
            fi
            
            echo "ARTIFACT_NAME=$artifact_name" >> "$GITHUB_OUTPUT"

        - name: Upload artifact
          if: inputs.create_artifact == 'true'
          uses: actions/upload-artifact@v4
          with:
            name: ${{ steps.artifact-prep.outputs.ARTIFACT_NAME }}
            path: ${{ env.arturoDistPath }}/*
            include-hidden-files: false