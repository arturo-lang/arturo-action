name: build

on:
    push:
        paths-ignore:
            - 'LICENSE'
            - '*.md'
        branches:
            - main
    pull_request:
        paths-ignore:
            - 'LICENSE'
            - '*.md'
    workflow_dispatch:

concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    crossplatform-tester:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os:
                    - ubuntu-latest
                    - windows-latest
                    - macOS-12
                    - macOS-14
                mode:
                    - full
                    - mini
                arch:
                    - native
                    - amd64
                    - arm64
                exclude:
                    - arch: arm64
                      os: macOS-12
                    - arch: amd64
                      os: macOS-14
                    - arch: arm64
                      os: windows-latest
                    - arch: arm64
                      os: ubuntu-latest
                      mode: full

        steps:
            - uses: actions/checkout@v4

            - name: Install Arturo
              uses: ./
              with: 
                token: ${{ secrets.GITHUB_TOKEN }}
                mode: ${{ matrix.mode }}
                arch: ${{ matrix.arch }}

            - if: matrix.os == 'windows-latest'
              name: Run tests (Windows)
              run: |
                echo "Current directory:"
                pwd
    
                echo "Current path:"
                echo $PATH
    
                echo "Current GITHUB_PATH:"
                echo $GITHUB_PATH
                #echo "$HOME/.arturo/bin" >> $GITHUB_PATH
                #ls $HOME/.arturo
                #ls $HOME/.arturo/bin
                arturo -v
                arturo tests/test.art
              shell: msys2 {0}

            - if: matrix.os != 'windows-latest' && (matrix.os != 'ubuntu-latest' || matrix.arch != 'arm64')
              name: Run tests (*nix)
              run: |
                arturo -v
                arturo tests/test.art
              shell: bash