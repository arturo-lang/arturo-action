name: Matrix

on:
    push:
        paths-ignore:
            - 'LICENSE'
            - '*.md'
        branches:
            - main
    pull_request:
        paths-ignore:
            - 'LICENSE'
            - '*.md'
    workflow_dispatch:

concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    test:
        runs-on: ${{ 
            (matrix.os == 'linux' && matrix.webkit == '40')     && 'ubuntu-22.04'   || 
            (matrix.os == 'macos' && matrix.arch == 'arm64')    && 'macos-latest'   || 
            (matrix.os == 'macos')                              && 'macOS-15-intel' || 
            (matrix.os == 'windows')                            && 'windows-latest' || 
                                                                   'ubuntu-latest'  }}
        strategy:
            matrix:
                include: 
                    - {os: linux,   arch: amd64, mode: full}
                    - {os: linux,   arch: amd64, mode: full, webkit: "41"}
                    - {os: linux,   arch: amd64, mode: safe}
                    - {os: linux,   arch: amd64, mode: mini}
                    - {os: linux,   arch: arm64, mode: mini}
                    # - {os: linux,   arch: x86,   mode: mini}
                    # - {os: linux,   arch: arm,   mode: mini}
                    - {os: freebsd, arch: amd64, mode: mini}
                    - {os: freebsd, arch: amd64, mode: full}
                    - {os: freebsd, arch: amd64, mode: full, webkit: "41"}
                    - {os: macos,   arch: amd64, mode: full}
                    - {os: macos,   arch: amd64, mode: mini}
                    - {os: macos,   arch: arm64, mode: full}
                    - {os: macos,   arch: arm64, mode: mini}
                    - {os: windows, arch: amd64, mode: full}
                    - {os: windows, arch: amd64, mode: mini}
                    - {os: web}
                    
        defaults:
            run:
                shell: ${{ 
                    (matrix.os == 'freebsd') && 'freebsd {0}' ||
                    (matrix.os == 'windows') && 'msys2 {0}'   || 
                                                'bash'        }}
        steps:
            - uses: actions/checkout@v4
 
            - name: Install Arturo
              uses: ./
              with: 
                token: ${{ secrets.GITHUB_TOKEN }}
                os: ${{ matrix.os }}
                arch: ${{ matrix.arch }}
                mode: ${{ matrix.mode }}
                webkit: ${{ matrix.webkit }}
                src: "clean-up-main-CI-action"

            - name: Verify installation
              run: |
                  echo "======================================"
                  echo "Verifying Arturo Installation"
                  echo "======================================"
                  echo "OS: ${{ matrix.os }} | Arch: ${{ matrix.arch || 'amd64' }} | Mode: ${{ matrix.mode || 'mini' }}"
                  echo "Shell: $SHELL"
                  echo "======================================"
                  
                  if [ "${{ matrix.os }}" = "freebsd" ]; then
                      echo ""
                      echo "========== DEBUG: FreeBSD Environment =========="
                      echo "HOME: $HOME"
                      echo "PWD: $PWD"
                      echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
                      echo ""
                      echo "========== PWD contents =========="
                      ls -lah
                      echo ""
                      echo "========== HOME/work contents =========="
                      ls -lah $HOME/work || echo "doesn't exist"
                      echo ""
                  fi
                  
                  # Check 1: arturo command (skip for web and cross-compiled arm64)
                  if [ "${{ matrix.os }}" != "web" ] && ! ([ "${{ matrix.os }}" = "linux" ] && [ "${{ matrix.arch }}" = "arm64" ]); then
                      echo "✓ Checking arturo command..."
                      if command -v arturo &> /dev/null; then
                          echo "  ✓ arturo command found at: $(which arturo)"
                          arturo -v
                      else
                          echo "  ✗ FAILED: arturo not found"
                          exit 1
                      fi
                  else
                      echo "⊘ Skipping arturo command check"
                  fi
                  
                  echo ""
                  
                  # Check 2: .arturo-dist folder
                  echo "✓ Checking .arturo-dist..."
                  if [ -d ".arturo-dist" ]; then
                      echo "  ✓ .arturo-dist exists at: $(pwd)/.arturo-dist"
                      ls -lh .arturo-dist/ || ls -l .arturo-dist/
                  else
                      echo "  ✗ FAILED: .arturo-dist not found in $(pwd)"
                      if [ "${{ matrix.os }}" = "freebsd" ]; then
                          echo "  Checking alternate locations:"
                          [ -d "$HOME/work/.arturo-dist" ] && echo "    Found at: $HOME/work/.arturo-dist" && ls -lh $HOME/work/.arturo-dist/
                          [ -d "$GITHUB_WORKSPACE/.arturo-dist" ] && echo "    Found at: $GITHUB_WORKSPACE/.arturo-dist" && ls -lh $GITHUB_WORKSPACE/.arturo-dist/
                      fi
                      exit 1
                  fi
                  
                  echo ""
                  
                  # Check 3: No arturo sources
                  echo "✓ Checking cleanup..."
                  if [ -d "arturo" ]; then
                      echo "  ✗ FAILED: arturo sources not cleaned"
                      exit 1
                  else
                      echo "  ✓ Sources cleaned"
                  fi
                  
                  echo ""
                  echo "======================================"
                  echo "All checks passed!"
                  echo "======================================"

            - if: env.ArturoCanRun == 'true'
              name: Run tests
              run: |
                arturo -v
                arturo tests/test.art