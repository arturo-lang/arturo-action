name: Matrix

on:
    push:
        paths-ignore:
            - 'LICENSE'
            - '*.md'
        branches:
            - main
    pull_request:
        paths-ignore:
            - 'LICENSE'
            - '*.md'
    workflow_dispatch:

concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    test:
        runs-on: ${{ 
            (matrix.os == 'linux')   && (matrix.support == 'legacy' && (matrix.arch == 'arm64' && 'ubuntu-22.04-arm' || 'ubuntu-22.04') || matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest') ||
            (matrix.os == 'macos')   && (matrix.arch == 'arm64' && 'macos-latest' || 'macOS-15-intel') ||
            (matrix.os == 'windows') && 'windows-latest' || 
                                        'ubuntu-latest'  }}
        strategy:
            matrix:
                include: 
                    - {os: linux,   arch: amd64,                        do: compile}
                    - {os: linux,   arch: amd64,    support: legacy,    do: compile}
                    - {os: linux,   arch: amd64,    mode: safe,         do: compile}
                    - {os: linux,   arch: amd64,    mode: mini,         do: compile}
                    - {os: linux,   arch: arm64,                        do: compile}
                    - {os: linux,   arch: arm64,    support: legacy,    do: compile}
                    - {os: linux,   arch: arm64,    mode: mini,         do: compile}
                    - {os: freebsd, arch: amd64,                        do: compile}
                    - {os: freebsd, arch: amd64,    mode: mini,         do: compile}
                    - {os: macos,   arch: amd64,                        do: compile}
                    - {os: macos,   arch: amd64,    mode: mini,         do: compile}
                    - {os: macos,   arch: arm64,                        do: compile}
                    - {os: macos,   arch: arm64,    mode: mini,         do: compile}
                    - {os: windows, arch: amd64,                        do: compile}
                    - {os: windows, arch: amd64,    mode: mini,         do: compile}
                    - {os: web,     arch: js,       mode: mini,         do: compile}

                    - {os: linux,   arch: amd64,                        do: fetch}
                    - {os: linux,   arch: amd64,    support: legacy,    do: fetch}
                    - {os: linux,   arch: amd64,    mode: safe,         do: fetch}
                    - {os: linux,   arch: amd64,    mode: mini,         do: fetch}
                    - {os: linux,   arch: arm64,                        do: fetch}
                    - {os: linux,   arch: arm64,    support: legacy,    do: fetch}
                    - {os: linux,   arch: arm64,    mode: mini,         do: fetch}
                    - {os: freebsd, arch: amd64,                        do: fetch}
                    - {os: freebsd, arch: amd64,    mode: mini,         do: fetch}
                    - {os: macos,   arch: amd64,                        do: fetch}
                    - {os: macos,   arch: amd64,    mode: mini,         do: fetch}
                    - {os: macos,   arch: arm64,                        do: fetch}
                    - {os: macos,   arch: arm64,    mode: mini,         do: fetch}
                    - {os: windows, arch: amd64,                        do: fetch}
                    - {os: windows, arch: amd64,    mode: mini,         do: fetch}
                    - {os: web,     arch: js,       mode: mini,         do: fetch}
                    
        defaults:
            run:
                shell: ${{ 
                    (matrix.os == 'freebsd') && 'freebsd {0}' ||
                    (matrix.os == 'windows') && 'msys2 {0}'   || 
                                                'bash'        }}
        steps:
            - uses: actions/checkout@v4
 
            - name: Install Arturo
              uses: ./
              with: 
                token: ${{ secrets.GITHUB_TOKEN }}
                os: ${{ matrix.os }}
                arch: ${{ matrix.arch }}
                mode: ${{ matrix.mode }}
                support: ${{ matrix.support }}

            - name: Verify installation
              run: |
                cd $GITHUB_WORKSPACE
                
                echo "======================================"
                echo "Verifying Arturo Installation"
                echo "======================================"
                echo "OS: ${{ matrix.os }} | Arch: ${{ matrix.arch || 'amd64' }} | Mode: ${{ matrix.mode || 'mini' }}"
                echo "======================================"
                
                if [ "${{ env.arturoCanRun }}" == "true" ]; then
                    echo "✓ Checking arturo command..."
                    if command -v arturo &> /dev/null; then
                        echo "  ✓ arturo command found"
                        arturo -v
                    else
                        echo "  ✗ FAILED: arturo not found"
                        exit 1
                    fi
                else
                    echo "⊘ Skipping arturo command check"
                fi
                
                echo ""
                echo "======================================"
                echo "Installation verified!"
                echo "======================================"

            - if: env.arturoCanRun == 'true'
              name: Run tests
              run: |
                cd $GITHUB_WORKSPACE
                arturo -v
                arturo tests/test.art